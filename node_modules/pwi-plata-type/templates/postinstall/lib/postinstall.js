import fs from 'node:fs'
import path from 'node:path'
import { tools } from './postinstall-tools.mjs'

const main = async() => {
    const plataDir = path.resolve('.')
    
    if (path.basename(path.dirname(plataDir)) !== 'node_modules') return

    const projectDir = path.resolve(plataDir, '..', '..')
    const projectPackageJson = JSON.parse(fs.readFileSync(path.join(projectDir, 'package.json')).toString())

    if (projectPackageJson.plata_no_setup !== undefined) {
        process.exit(0)
    }

    const t = tools({
        plataDir,
        projectDir,
        templateDir: plataDir
    })

    const promises = []

    promises.push(t.copyFolderToProject('configs'))
    promises.push(t.syncFolderProject('clusters'))
    promises.push(t.syncFolderProject('libs'))
    promises.push(t.syncFolderProject('tasks'))
    promises.push(t.syncFolderProject('@types'))

    await Promise.all(promises)
}

main()